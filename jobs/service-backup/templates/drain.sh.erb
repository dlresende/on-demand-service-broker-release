#!/usr/bin/env bash

# Kill the service-backup process so it doesn't spawn any more 'source_exe's
# after we've killed the existing ones

pidfile=/var/vcap/sys/run/service-backup.pid
kill $(cat $pidfile)

tick=0
timeout=60
while [ $tick -lt $timeout ]; do
	process_name=$(grep source_executable /var/vcap/jobs/service-backup/config/backup.yml | cut -d\" -f2)
	if [ "$process_name" = "source_executable:" ]; then
	  # source_executable is not set, so nothing to kill
		echo 0
		exit 0
	fi

	pids=$(ps aux | grep "$process_name" | grep -v \\bgrep\\b | awk '{print $2}')

	if [ ${#pids} -ne 0 ]; then
		kill ${pids}
	else
		echo 0
		exit 0
	fi
	sleep 5
	(( tick++ ))
done

exit 1
